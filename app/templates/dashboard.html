{% extends "base.html" %}
{% block title %}Dashboard â€” VOD Transcription{% endblock %}

{% block content %}
<div class="min-h-full">
    <nav class="bg-indigo-600">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <h1 class="text-xl font-bold text-white">VOD Transcription</h1>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-indigo-200">{{ user_display_name }}</span>
                    <a href="/logout" class="text-sm text-white hover:text-indigo-200">Sign out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        <!-- Submit Job -->
        <div class="mb-8 rounded-lg bg-white p-6 shadow">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Submit New Transcription</h2>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <!-- Upload form -->
                <form action="/api/jobs" method="post" enctype="multipart/form-data" class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Upload Video File</label>
                    <input type="file" name="file" accept=".mp4,.mov,.mkv"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-indigo-50 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-indigo-700 hover:file:bg-indigo-100"
                           required>
                    <button type="submit"
                            class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                        Upload & Transcribe
                    </button>
                </form>

                <!-- URL form -->
                <form id="url-form" class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Direct Video URL</label>
                    <input type="url" name="url" placeholder="https://example.com/video.mp4"
                           class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                           required>
                    <button type="submit"
                            class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                        Fetch & Transcribe
                    </button>
                </form>
            </div>
        </div>

        <!-- Job List -->
        <div class="rounded-lg bg-white shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Transcription Jobs</h2>
            </div>
            {% if jobs %}
            <ul class="divide-y divide-gray-200">
                {% for job in jobs %}
                <li class="px-6 py-4">
                    <a href="/jobs/{{ job.id }}" class="flex items-center justify-between hover:bg-gray-50 -mx-6 -my-4 px-6 py-4">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ job.source_label }}</p>
                            <p class="text-xs text-gray-500">{{ job.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            {% if job.duration_seconds %}
                            <span class="text-xs text-gray-400">{{ (job.duration_seconds // 60) }}m {{ job.duration_seconds % 60 }}s</span>
                            {% endif %}
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                                {% if job.status.value == 'completed' %}bg-green-100 text-green-800
                                {% elif job.status.value == 'failed' %}bg-red-100 text-red-800
                                {% elif job.status.value == 'processing' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ job.status.value }}
                            </span>
                        </div>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="px-6 py-12 text-center text-sm text-gray-500">
                No transcription jobs yet. Submit a video to get started.
            </div>
            {% endif %}
        </div>
    </main>
</div>

<script>
document.getElementById('url-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = e.target.querySelector('input[name="url"]').value;
    const res = await fetch('/api/jobs', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url})
    });
    if (res.ok) {
        window.location.reload();
    } else {
        const err = await res.json();
        alert(err.message || 'Failed to create job');
    }
});
</script>
{% endblock %}
